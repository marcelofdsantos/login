<div class="checklist-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>Checklist de Empilhadeiras</mat-card-title>
      <mat-card-subtitle>
        Operador: {{ nomeOperador }} ({{ reOperador }})
      </mat-card-subtitle>
      <button mat-icon-button (click)="logout()" class="logout-btn" title="Sair">
        <mat-icon>logout</mat-icon>
      </button>
    </mat-card-header>
  </mat-card>

  <form [formGroup]="form" (ngSubmit)="salvar()">
    <!-- Sele√ß√£o de Empilhadeira -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>1. Empilhadeira</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Selecione a Empilhadeira</mat-label>
          <mat-select formControlName="empilhadeiraId" [disabled]="carregando">
            <mat-option *ngFor="let emp of empilhadeirasDisponiveis" [value]="emp.id">
              {{ emp.modelo }} - {{ emp.tipo }} ({{ emp.capacidade }}t)
            </mat-option>
          </mat-select>
          <mat-error>Selecione uma empilhadeira</mat-error>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Dados da Vistoria -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>2. Dados da Vistoria</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Data</mat-label>
            <input matInput type="date" formControlName="data" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Hora</mat-label>
            <input matInput type="time" formControlName="horaVistoria" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Turno</mat-label>
            <mat-select formControlName="turno">
              <mat-option *ngFor="let turno of turnos" [value]="turno.value">
                {{ turno.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Hor√≠metro Inicial</mat-label>
            <input matInput type="number" formControlName="horimetroInicial" />
            <mat-error>Campo obrigat√≥rio</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Hor√≠metro Final</mat-label>
            <input matInput type="number" formControlName="horimetroFinal" />
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Itens Conformes -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>3. Itens Conformes</mat-card-title>
        <mat-card-subtitle>Itens que n√£o bloqueiam a opera√ß√£o</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div formArrayName="conformes">
          <div *ngFor="let item of conformes.controls; let i = index" [formGroupName]="i" class="item-row">
            <div class="item-label">
              <span class="item-number">{{ i + 1 }}.</span>
              {{ item.value.nome }}
            </div>
            <mat-radio-group formControlName="status" class="item-radio-group">
              <mat-radio-button value="OK" color="primary">OK</mat-radio-button>
              <mat-radio-button value="NAO_CONFORME" color="warn">N√£o Conforme</mat-radio-button>
            </mat-radio-group>
            <mat-form-field appearance="outline" class="item-observacao" *ngIf="item.value.status === 'NAO_CONFORME'">
              <mat-label>Observa√ß√£o</mat-label>
              <input matInput formControlName="observacao" placeholder="Descreva o problema" />
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Itens Impeditivos -->
    <mat-card class="section-card impeditivo-card">
      <mat-card-header>
        <mat-card-title>4. Itens Impeditivos ‚ö†Ô∏è</mat-card-title>
        <mat-card-subtitle>üö´ Item n√£o conforme BLOQUEIA a empilhadeira</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div formArrayName="impeditivos">
          <div *ngFor="let item of impeditivos.controls; let i = index" [formGroupName]="i" class="item-row impeditivo-row">
            <div class="item-label">
              <span class="item-number">{{ i + 1 }}.</span>
              {{ item.value.nome }}
              <mat-icon *ngIf="item.value.status === 'NAO_CONFORME'" class="warning-icon">warning</mat-icon>
            </div>
            <mat-radio-group formControlName="status" class="item-radio-group">
              <mat-radio-button value="OK" color="primary">OK</mat-radio-button>
              <mat-radio-button value="NAO_CONFORME" color="warn">N√£o Conforme</mat-radio-button>
            </mat-radio-group>
            <mat-form-field appearance="outline" class="item-observacao" *ngIf="item.value.status === 'NAO_CONFORME'">
              <mat-label>Observa√ß√£o (Obrigat√≥ria)</mat-label>
              <input matInput formControlName="observacao" placeholder="Descreva o problema URGENTE" />
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Observa√ß√£o Geral -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>5. Observa√ß√£o Geral (Opcional)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Observa√ß√µes adicionais</mat-label>
          <textarea matInput formControlName="observacaoGeral" rows="3"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Alerta se houver impeditivo n√£o conforme -->
    <mat-card *ngIf="existeImpeditivoNaoConforme()" class="alert-card">
      <mat-card-content>
        <div class="alert-content">
          <mat-icon>warning</mat-icon>
          <div>
            <strong>‚ö†Ô∏è ATEN√á√ÉO!</strong>
            <p>Existem itens impeditivos n√£o conformes. A empilhadeira ser√° BLOQUEADA automaticamente ap√≥s salvar.</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Bot√£o Salvar -->
    <div class="action-buttons">
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="form.invalid || salvando"
        class="btn-save"
      >
        <mat-icon>save</mat-icon>
        {{ salvando ? 'Salvando...' : 'Salvar Checklist' }}
      </button>
    </div>
  </form>
</div>
